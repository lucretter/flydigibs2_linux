name: Build and Release Packages

permissions:
  contents: write
  packages: write
  pull-requests: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install build-time dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ruby ruby-dev build-essential \
            tcl tcl-dev tk tk-dev tcllib \
            libhidapi-hidraw0 libhidapi-libusb0  # Add HID libraries
          sudo gem install --no-document fpm

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller Pillow ttkbootstrap hidapi

      - name: Create desktop file
        run: |
          # Create icon directory
          mkdir -p package-files/usr/share/pixmaps
          cp bs2pro/icon.png package-files/usr/share/pixmaps/bs2pro-controller.png
          mkdir -p package-files/usr/share/applications
          cat > package-files/usr/share/applications/bs2pro-controller.desktop << EOF
          [Desktop Entry]
          Version=1.0
          Type=Application
          Name=BS2PRO Controller
          Comment=Controller for BS2PRO devices
          Exec=/usr/bin/bs2pro_controller
          Icon=/usr/share/pixmaps/bs2pro-controller.png
          Categories=Utility;
          Terminal=false
          StartupNotify=false
          EOF

      - name: Check Tcl/Tk installation
        run: |
          echo "Checking Tcl/Tk installation..."
          echo "Tcl version:"
          tclsh <<< 'puts $tcl_version'
          echo "Tk version:"
          tclsh <<< 'package require Tk; puts [info patchlevel]'
          echo "Available Tcl/Tk paths:"
          find /usr -name "*tcl*" -type d 2>/dev/null | head -10
          find /usr -name "*tk*" -type d 2>/dev/null | head -10
          echo "msgcat locations:"
          find /usr -name "msgcat*" -type d 2>/dev/null || echo "No msgcat found"

      - name: Build binary
        run: |
          # Build PyInstaller command with conditional binary inclusion
          PYINSTALLER_CMD="pyinstaller --noconfirm --onefile --name bs2pro_controller \
            --hidden-import=PIL._tkinter_finder \
            --hidden-import=hidapi \
            --hidden-import=ttkbootstrap \
            --hidden-import=tcl_init \
            --collect-data ttkbootstrap \
            --exclude-module=tkinter.test \
            --exclude-module=test \
            --additional-hooks-dir=. \
            --add-data 'bs2pro/icon.png:.' \
            --add-data 'bs2pro/tcl:./tcl'"
          
          # Add Tcl/Tk binaries only if they exist
          if [ -d "/usr/lib/tcl8.6" ]; then
            PYINSTALLER_CMD="$PYINSTALLER_CMD --add-binary '/usr/lib/tcl8.6:./tcl8.6'"
          fi
          
          if [ -d "/usr/lib/tk8.6" ]; then
            PYINSTALLER_CMD="$PYINSTALLER_CMD --add-binary '/usr/lib/tk8.6:./tk8.6'"
          fi
          
          if [ -d "/usr/lib/tcl8.6/msgcat1.7.1" ]; then
            PYINSTALLER_CMD="$PYINSTALLER_CMD --add-binary '/usr/lib/tcl8.6/msgcat1.7.1:./tcl8.6/msgcat1.7.1'"
          elif [ -d "/usr/share/tcl8.6/msgcat1.7.1" ]; then
            PYINSTALLER_CMD="$PYINSTALLER_CMD --add-binary '/usr/share/tcl8.6/msgcat1.7.1:./tcl8.6/msgcat1.7.1'"
          fi
          
          # Add the main script and execute
          PYINSTALLER_CMD="$PYINSTALLER_CMD bs2pro/main.py"
          
          echo "Running: $PYINSTALLER_CMD"
          eval $PYINSTALLER_CMD

      - name: Build .deb with dependencies
        run: |
          # Create .deb with proper dependencies
          fpm -s dir -t deb -n bs2pro-controller -v "${GITHUB_REF_NAME#v}" \
            -d "libhidapi-hidraw0" \
            -d "libhidapi-libusb0" \
            -d "python3-tk" \
            --description "Controller for BS2PRO devices" \
            --url "https://github.com/lucretter/flydigibs2_linux" \
            --maintainer "Lucretter" \
            --category "utils" \
            dist/bs2pro_controller=/usr/bin/bs2pro_controller \
            package-files/usr/share/applications/bs2pro-controller.desktop=/usr/share/applications/ \
            package-files/usr/share/pixmaps/bs2pro-controller.png=/usr/share/pixmaps/bs2pro-controller.png

      - name: Build .rpm with dependencies
        run: |
          # Create .rpm with proper dependencies
          fpm -s dir -t rpm -n bs2pro-controller -v "${GITHUB_REF_NAME#v}" \
            -d "hidapi" \
            -d "python3-tkinter" \
            -d "tcl" \
            -d "tk" \
            -d "python3-tkinter" \
            --description "Controller for BS2PRO devices" \
            --url "https://github.com/lucretter/flydigibs2_linux" \
            --maintainer "Lucretter" \
            --category "Applications/System" \
            dist/bs2pro_controller=/usr/bin/bs2pro_controller \
            package-files/usr/share/applications/bs2pro-controller.desktop=/usr/share/applications/ \
            package-files/usr/share/pixmaps/bs2pro-controller.png=/usr/share/pixmaps/bs2pro-controller.png

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.deb
            *.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}